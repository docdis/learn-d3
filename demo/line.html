<html>
<meta http-equiv="Content-type" content="text/html;charset=UTF-8">
<head>
<title>Average Achievements Per Learner Per Day</title>
<!--
<script src="http://d3js.org/d3.v3.js"></script>
<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.11.0/jquery.min.js"></script>
-->
<script type="text/javascript" src="jquery.min.js"></script>
<script type="text/javascript" src="d3.v3.min.js"></script>
<script type="text/javascript" src="date-utils.min.js"></script>
<script>

function getMaxObjectValue(this_array, element) {
	var values = [];
	for (var i = 0; i < this_array.length; i++) {
			values.push(Math.ceil(parseFloat(this_array[i][""+element])));
	}
	values.sort(function(a,b){return a-b});
	return values[values.length-1];
}

function getMinObjectValue(this_array, element) {
	var values = [];
	for (var i = 0; i < this_array.length; i++) {
			values.push(Math.floor(parseFloat(this_array[i][""+element])));
	}
	values.sort(function(a,b){return a-b});
	return values[0];
}

// Our end result is a graph like this:
//  __________________________
//  | # activities per user  |
//  | 3|     .   .           |
//  | 2|	   .             |
//  | 1| .         .         |
//  | 0|___._________._      | 
//  |    M T W T F S S  Date |
//  |________________________|
//
// Y-axis: Activities per user per day
// X-axis: Date MM/DD
//

//
// Get dateRange by taking the first date a user was created [startDate]
// and creating a range till today [endDate] 
// ( Later on we need to add a date range limit to ensure we only get the 
// 	last 365 days of data to avoid two entries for 01-01 etc. #later )
// See: DU.parseDate
// We need to parse the first date in our learnersbydate series
// parse a date in yyyy-mm-dd format return full JS Date object
// see: http://stackoverflow.com/questions/2587345/javascript-date-parse

// 
// Next we divide the number of achievements by number of learners
// 



$(document).ready(function() {
var dateRange = [],   // used to draw the axis below
	aapd = {};        // average achievements per day


// To derive our co-ordinate data we will get data from MySQL in form of:
// learnersbydate.json example:
// [["2014-01-23",32],["2014-01-28",1],["2014-01-31",3],["2014-02-02",2]]
// 	
$.get("learnersbydate.json", function(lbd) {

	var startDate = lbd[0][0]; // first date in the learnersbydate.json is date first user was created
	// since there is no activity without users we derive our dateRange
	// from the first user creation date.
	dateRange = DU.dateRange(startDate);
	// console.log(dateRange);
	// loop through all the
	var j = 0, i = 0, learnerCount = 0,
	learnersByDate = {};
	// Next we Create an object of Cumulative users for each date in the range
	// ( Rather complicating the SQL Query I derive from the raw data )
	while(i < dateRange.length) {
		if(dateRange[i] === lbd[j][0]) {
			learnerCount = learnerCount + parseInt(lbd[j][1], 10);
			if(j < lbd.length -1){
				j = j + 1;
			}
		}
		learnersByDate[dateRange[i]] = learnerCount;
		// console.log(dateRange[i] +" : " +learnerCount )
		i = i + 1;
	};
	// console.log(learnersByDate);
		// achievementsbydate.json example:
		// [["2014-01-23",4],["2014-01-24",8],["2014-01-27",8],["2014-01-28",1],
		// ["2014-01-29",3],["2014-02-03",10],["2014-02-04",1],["2014-02-05",2]]
		$.get("achievementsbydate.json", function(abd) {
			var i = 0, j = 0, aa = 0; // average achivements
			while(i < dateRange.length) {
				if(dateRange[i] === abd[j][0]) {
				// using the learnersbydate data above:
				// usersPerDate = { "2014-01-23":32, "2014-01-24":32, "2014-01-25":32, 
				// "2014-01-26":32, "2014-01-27":32, "2014-01-28":33, "2014-01-29":33, 
				// "2014-01-30":33, "2014-01-31":36, "2014-02-01":36, "2014-02-02":38 };
				aa = parseInt(abd[j][1], 10) / parseInt(learnersByDate[dateRange[i]], 10);
				if(j < abd.length -1){
					j = j + 1;
				}
			} else {
				aa = 0;
			}
			aapd[dateRange[i]] = aa;
			console.log(dateRange[i] +" : " +aa )
			i = i + 1;
			}
			console.log(aapd);

  		renderGraph();
	});
});



function renderGraph(){

	var data = [];  								
	var startingDate =  DU.parseDate(dateRange[0]); // new Date(2012, 8, 18);		
	// this is a date object. each of our data objects is attached to a date
	for (var i = 0; i < dateRange.length; i++) {					
	// loop 10 times to create 10 data objects
		var tmpObj 	= {};							
			// this is a temporary data object
		tmpObj.date = new Date(startingDate.getFullYear(), startingDate.getMonth(), startingDate.getDate()+i);				
		// the data for this data object. Increment it from the starting date.
		tmpObj.DAU 	= aapd[dateRange[i]];  			
			// random value. Round it to a whole number.
		data.push(tmpObj); 							
			// push the object into our data array
	}


	var width = document.documentElement.clientWidth - 70, height = 400;
	var margin = {top: 30, right: 10, bottom: 50, left: 60}, width = width - margin.left - margin.right, height = height - margin.top - margin.bottom;
	// these are graph size settings

	var minDate = (data[0].date),
	maxDate = data[data.length-1].date;
	minObjectValue = getMinObjectValue(data, 'DAU');
	maxObjectValue = getMaxObjectValue(data, 'DAU');

	//create the graph object
	document.getElementById("metrics").innerHTML = ''; // clear to re-draw
	var vis= d3.select("#metrics").append("svg")
    	.data(data)
		.attr("class", "metrics-container")
   		.attr("width", width + margin.left + margin.right)
    	.attr("height", height + margin.top + margin.bottom)
  	.append("g")
    	.attr("transform", "translate(" + margin.left + "," + margin.top + ")");

	var y = d3.scale.linear().domain([ minObjectValue - (.1 * minObjectValue) , maxObjectValue + (.1 * maxObjectValue) ]).range([height, 0]),
	x = d3.time.scale().domain([minDate, maxDate]).range([0, width]);

	var yAxis = d3.svg.axis()
		.scale(y)
		.orient("left")
		.ticks(5);

	var xAxis = d3.svg.axis()
		.scale(x)
		.orient("bottom")
		.ticks(40);

	vis.append("g")
	    .attr("class", "axis")
	    .call(yAxis);

	vis.append("g")
		.attr("class", "axis x-axis")
	    .attr("transform", "translate(0," + height + ")")
	    .call(xAxis);

	//add the axes labels
	vis.append("text")
	    .attr("class", "axis-label")
	    .attr("text-anchor", "end")
	    .attr("x", document.documentElement.clientWidth - 150)
	    .attr("y", height + -134)
	    .text('');

	vis.append("text")
	    .attr("class", "axis-label")
	    .attr("text-anchor", "end")
	    .attr("y", 6)
	    .attr("dy", "-3.4em")
	    .attr("transform", "rotate(-90)")
	    .text('# Average Activities Logged Per Learner');

	var line = d3.svg.line()
		.x(function(d) { return x(d["date"]); })
		.y(function(d) { return y(d["DAU"]); })

	vis.append("svg:path")
		.attr("d", line(data))
		.style("stroke", function() { 
			return "#333";
		})
		.style("fill", "none")
		.style("stroke-width", "2.5");

		var dataCirclesGroup = vis.append('svg:g');

		var circles = dataCirclesGroup.selectAll('.data-point')
			.data(data);

		circles
			.enter()
			.append('svg:circle')
			.attr('class', 'dot')
			.attr('fill', function() { return "#809E35"; })
			.attr('cx', function(d) { return x(d["date"]); })
			.attr('cy', function(d) { return y(d["DAU"]); })
			.attr('r', function() { return 4; });

		// rotate x-axis labels by -90 degrees to fit more in.
		vis.selectAll(".x-axis text")
      	.attr("transform", function(d) { return "translate(" + -10 + ", " + 30 + ") rotate(-90)" });
}

	$( window ).resize(function() {
	  renderGraph();
	});
}); //  end $(document).ready()

</script>

<style>
h1 {
	color: #333;
	font-size: 4em;
}
.axis path, .axis line {
  fill: none;
  stroke: #42494C;
  shape-rendering: crispEdges;
}

.line {
  fill: none;
  stroke-width: 1.5px;

}

body { 
	background: #FFFFFF; 
	background-repeat:repeat-x;
	text-align: center;
	font: 10px sans-serif;
}
/*
.dot {
  stroke-width: 2.5px;
}

.dot-selected {
  fill: #809E35;
  stroke: #809E35;
  stroke-width: 2.5px;
}

.metrics-container {
	width: auto;
	height: auto;
	padding: 10px 10px 10px 10px;
	border-style: solid;
	border-width: 1px;
	float: left;
	margin-left: 20px;
	margin-top: 20px;
}
*/
</style>

</head>

<body>

	<h1>Average Achievements Per Learner Per Day (OMTM)</h1>

	<div id="metrics">
	</div>

</body>

</html>