<html>
<meta http-equiv="Content-type" content="text/html;charset=UTF-8">
<head>
<title>Activity Graph</title>
<script src="http://d3js.org/d3.v2.js"></script>
<script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js"></script>
<script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jqueryui/1.8.21/jquery-ui.min.js"></script>
<script>

function getMaxObjectValue(this_array, element) {
	var values = [];
	for (var i = 0; i < this_array.length; i++) {
			values.push(Math.ceil(parseFloat(this_array[i][""+element])));
	}
	values.sort(function(a,b){return a-b});
	return values[values.length-1];
}

function getMinObjectValue(this_array, element) {
	var values = [];
	for (var i = 0; i < this_array.length; i++) {
			values.push(Math.floor(parseFloat(this_array[i][""+element])));
	}
	values.sort(function(a,b){return a-b});
	return values[0];
}

// Our end result is a graph like this:
//  __________________________
//  | # activities per user  |
//  | 3|     .   .           |
//  | 2|	   .             |
//  | 1| .         .         |
//  | 0|___._________._      | 
//  |    M T W T F S S  Date |
//  |________________________|
//
// Y-axis: Activities per user per day
// X-axis: Date MM/DD
//
// To derive our co-ordinate data we will get data from MySQL in form of:
// learnersbydate.json
// [["2014-01-23",32],["2014-01-28",1],["2014-01-31",3],["2014-02-02",2]]
// 
// achievementsbydate.json
// [["2014-01-23",4],["2014-01-24",8],["2014-01-27",8],["2014-01-28",1],
//  ["2014-01-29",3],["2014-02-03",10],["2014-02-04",1],["2014-02-05",2]]
//
// Get dateRange by taking the first date a user was created [startDate]
// and creating a range till today [endDate] 
// ( Later on we need to add a date range limit to ensure we only get the 
// 	last 365 days of data to avoid two entries for 01-01 etc. #later )

// We need to parse the first date in our learnersbydate series
// parse a date in yyyy-mm-dd format return full JS Date object
// see: http://stackoverflow.com/questions/2587345/javascript-date-parse
function parseDate(input) {
	var parts = input.split('-'),
  // new Date(year, month [, day [, hours[, minutes[, seconds[, ms]]]]])
  	date = new Date(parts[0], parts[1]-1, parts[2]); // Note: months are 0-based
  	console.log(input +" >> " +date);
	return date
}
// parseDate("2014-01-23");

// if a number is below 10 and we want it to have a leading zero
// 01 or 06 instead of 1 or 6 we need to add the leading zero mannually
function addLeadingZero(input) {
	if(parseInt(input, 10) < 10){
		return "0"+input;
	} else {
		return input;  // no need ot add leading zero
	}
}
// console.log("6 with leading zero is: " +addLeadingZero(6));


// Takes full JS Date e.g: Thu Feb 06 2014 13:04:44 GMT+0000 (GMT)
// and returns YYYY-MM-DD e.g. 2014-02-06
function simpleDate(input) {

	var DD, MM, YYYY;
	// if input is undefined or not a valid date
	if(typeof endDate === 'undefined' || !input.getDate()) {
		var input = new Date();            // today's date
	}

	DD            = input.getDate();
	MM            = input.getMonth()+1;    // +1 because January is 0!
	YYYY          = input.getFullYear();
	return YYYY+"-"+addLeadingZero(MM)+"-"+addLeadingZero(DD);
}
// console.log("Simple Date: "+simpleDate());

// returns array of days between startDate and endDate
// endDate defaults to today if not specified
// expects format YYYY-MM-DD
function dateRange(startDate, endDate) {
	var	dateRange     = [];                    // array to be returned

	if(typeof endDate === 'undefined') {       // check startDate is Set
		var d = parseDate(startDate);          // used in while loop below
	} else {
		return false; // empty
	}

	if(typeof endDate === 'undefined') {       // if endDate is not set
		var today     = new Date();            // today's full JS date

		// endDate       = parseDate(endDate);    // Today's date without time
	} else {
		endDate = parseDate(endDate);
	}

	console.log()
	while(d < endDate) {

		dateRange.push(d);

		// Adding a day to a date: http://stackoverflow.com/questions/563406
		var nextDate = parseDate(d), // parse the date string into JS
		// add 1 day to the original startDate
		i;

	}

	return dateRange;
}
// addapted from: http://stackoverflow.com/questions/563406/
function addDayToDate(input) {
	if(typeof input === 'undefined') {
		console.log("No input supplied to addDayToDate!");
		return false;
	}
	if(typeof input.getDate === "undefined" || typeof input.getDate !== "function") {
		console.log("Parsing date ... "+input)
		input = parseDate(input);
	}
	var nextDay = new Date();
	nextDay.setDate(input.getDate()+1);
	console.log(input + " | +1 day >> " +nextDay);
	return nextDay;
}

// console.log( parseDate("2014-01-23") > parseDate("2014-02-02") );
console.log("2014-01-23 + 1 = "+simpleDate(addDayToDate("2014-01-23")));
// console.log(new Date());
//
//
// Next we Create an object of Cumulative users for each date in the range
// ( Rather complicating the SQL Query I derive from the raw data )
//
// using the learnersbydate data above:
// usersPerDate = { "2014-01-23":32, "2014-01-24":32, "2014-01-25":32, 
// "2014-01-26":32, "2014-01-27":32, "2014-01-28":33, "2014-01-29":33, 
// "2014-01-30":33, "2014-01-31":36, "2014-02-01":36, "2014-02-02":38 };
// 
// Next we divide the numbe of achievements by number of learners
// 

//

$(document).ready(function() {

$( function(){
	// since there is no activity without users we derive our dateRange
	// from the first user creation date.
	var dateRange = []; 
	$.get("learnersbydate.json", function(lbd) {


  		$.get("achievementsbydate.json", function(abd) {


    
      // $.each(lbd, function(index, value){
      //   console.log(value[0] +" >> " +value[1]);
      // })
      // $.each(abd, function(index, value){
      //   console.log(value[0] +" >> " +value[1]);
      // })
      renderGraph(abd, lbd)
    })
  })
})


function renderGraph(xData, yData){
	// console.log(xData);
	// console.log(yData);
}

	// adapted from: https://gist.github.com/ESeufert/3394672
	var data = [];  								
	// this is our data array
	var startingDate = new Date(2012, 8, 18);		
	// this is a date object. each of our data objects is attached to a date
	for (var i = 0; i < 10; i++) {					
	// loop 10 times to create 10 data objects
		var tmpObj 	= {};							
			// this is a temporary data object
		tmpObj.date = new Date(startingDate.getFullYear(), startingDate.getMonth(), startingDate.getDate()+i);				
			// the data for this data object. Increment it from the starting date.
		tmpObj.DAU 	= Math.round(Math.random() * 3);  			
			// random value. Round it to a whole number.
		data.push(tmpObj); 							
			// push the object into our data array
	}

	var width = 500, height = 300;
	var margin = {top: 30, right: 10, bottom: 40, left: 60}, width = width - margin.left - margin.right, height = height - margin.top - margin.bottom;
	// these are graph size settings

	var minDate = (data[0].date),
	maxDate = data[data.length-1].date;
	minObjectValue = getMinObjectValue(data, 'DAU');
	maxObjectValue = getMaxObjectValue(data, 'DAU');

	//create the graph object
	var vis= d3.select("#metrics").append("svg")
    	.data(data)
		.attr("class", "metrics-container")
   		.attr("width", width + margin.left + margin.right)
    	.attr("height", height + margin.top + margin.bottom)
  	.append("g")
    	.attr("transform", "translate(" + margin.left + "," + margin.top + ")");

	var y = d3.scale.linear().domain([ minObjectValue - (.1 * minObjectValue) , maxObjectValue + (.1 * maxObjectValue) ]).range([height, 0]),
	x = d3.time.scale().domain([minDate, maxDate]).range([0, width]);

	var yAxis = d3.svg.axis()
		.scale(y)
		.orient("left")
		.ticks(5);

	var xAxis = d3.svg.axis()
		.scale(x)
		.orient("bottom")
		.ticks(5);

	vis.append("g")
	    .attr("class", "axis")
	    .call(yAxis);

	vis.append("g")
		.attr("class", "axis")
	    .attr("transform", "translate(0," + height + ")")
	    .call(xAxis);

	//add the axes labels
	vis.append("text")
	    .attr("class", "axis-label")
	    .attr("text-anchor", "end")
	    .attr("x", 20)
	    .attr("y", height + 34)
	    .text('Date');

	vis.append("text")
	    .attr("class", "axis-label")
	    .attr("text-anchor", "end")
	    .attr("y", 6)
	    .attr("dy", "-3.4em")
	    .attr("transform", "rotate(-90)")
	    .text('# Activities Logged');

	var line = d3.svg.line()
		.x(function(d) { return x(d["date"]); })
		.y(function(d) { return y(d["DAU"]); })

	vis.append("svg:path")
		.attr("d", line(data))
		.style("stroke", function() { 
			return "#000000";
		})
		.style("fill", "none")
		.style("stroke-width", "2.5");

		var dataCirclesGroup = vis.append('svg:g');

		var circles = dataCirclesGroup.selectAll('.data-point')
			.data(data);

		circles
			.enter()
			.append('svg:circle')
			.attr('class', 'dot')
			.attr('fill', function() { return "green"; })
			.attr('cx', function(d) { return x(d["date"]); })
			.attr('cy', function(d) { return y(d["DAU"]); })
			.attr('r', function() { return 3; })


});

</script>

<style>
.axis path, .axis line {
  fill: none;
  stroke: #000;
  shape-rendering: crispEdges;
}

.line {
  fill: none;
  stroke-width: 1.5px;

}

body { 
	background: #FFFFFF; 
	background-repeat:repeat-x;
	text-align: center;
	font: 10px sans-serif;
}

.dot {
  stroke-width: 1.5px;
}

.dot-selected {
  fill: #B0C4DE;
  stroke: #B0C4DE;
  stroke-width: 1.5px;
}

.metrics-container {
	width: auto;
	height: auto;
	padding: 10px 10px 10px 10px;
	border-style: solid;
	border-width: 1px;
	float: left;
	margin-left: 20px;
	margin-top: 20px;
}
</style>

</head>

<body>

	<h1>Activity Graph</h1>

	<div id="metrics">
	</div>

</body>

</html>